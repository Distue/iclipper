#!/usr/bin/env python

#-------------------------------------------------------------
# Thomas Schwarzl <schwarzl@embl.de>
#-------------------------------------------------------------


'''

SYNOPSIS

    iclipper.py [options]

DESCRIPTION


    [-b, --bam=FILE]
                          BAM file for input
                          default: input.bam

    [-g, --gtf]          GTF file

    [-o, --output-dir=DIR]
                          Output directory. Will be created if it does not exist
                          default: output
                        
    [-h, --help]          display help message with all paramters and options

    
    [--verbose]           display verbose output for debugging


EXAMPLES

    python iclipper.py -b input.bam -g input.gtf -o output

    python iclipper.py --help



AUTHOR

    Thomas Schwarzl <schwarzl@embl.de>

'''

from lib.iCLIP import iCLIP
import optparse, traceback, os, time

VERSION = "0.01"

#-------------------------------------------------------------
def main ():
      global options, args

      if options.force or not os.path.isfile(os.path.join(options.outputDir, 'finished')):
          if options.verbose == True:
             print '---------------------------------------------'
             print 'Input:'
             print '---------------------------------------------'
             print 'Verbose: %s' % options.verbose
             print 'Output directory: %s' % options.outputDir
             print 'Bam file input:   %s' % options.bamfile
             print 'Min Alignment Quality: %s' % options.minAlignmentQuality
             print 'Is GTF stranded: %s' % options.stranded
             print 'GTF name: %s' % options.gtfname
             print 'Min Read Length: %s' % options.minReadLength
             print 'Max Read Length: %s' % options.maxReadLength
             print 'Max Read Interval Length: %s' % options.maxReadIntervalLength
             print '---------------------------------------------'

          ## initialize the iCLIP object. Reads in the
          iclip = iCLIP(options)


          # Initialized data
          # Reads the bam file and determines the min and max read length.
          # Saves the position of start/middle/end sites and deletions
          # Stores a coverage
          # Does a read statistic
          iclip.readBamFile()

          ## Read the Exon GTF
          iclip.readExonGTF(options.gtfname)


          ## Filter of Deletions
          ## When read-through happens in iCLIP, the deletion rate is increased.
          ## Here the deletions are filtered
          #iclip.filterDeletions()


          # Calculate the distances from reads, therefore the
          #iclip.calculateDistancesFromReads()
          iclip.calculateDistancesFromSites()


          ##Write the output

          iclip.writeOutput()

          ## Plot the output
          #iclip.plotOutput()

          finished(options.outputDir)
      else:
          print "Output already exists. Delete the 'finished' file or use the -f argument to overwrite results."

# =====================================================================================

#-------------------------------------------------------------
def finished(outputDir):
    f = open(os.path.join(outputDir, 'finished'), 'w')
    f.write(time.strftime("%c") + " " + str(VERSION))
    f.close()

#-------------------------------------------------------------
def checkDirExistsElseCreate(directory):
   if (notEmpty(directory)):
      parser.error ('%s is not a valid directory name' % directory)
   if not os.path.exists(directory):
      os.makedirs(directory)
   if (os.path.exists(directory) == False):
      parser.error ('%s does not exist' % directory)

#-------------------------------------------------------------
def checkFileExists(filename):
   if (notEmpty(filename)):
      parser.error ('%s is not a valid filename' % filename)
   if (os.path.isfile(filename) == False):
      parser.error ('%s does not exist' % filename)

#-------------------------------------------------------------
def notEmpty(filename):
   return filename == False or filename == ''

# =====================================================================================

# program can be used as standalone or as module
if __name__ == '__main__':
   try:
      # get parser and add arguments
      parser = optparse.OptionParser(formatter=optparse.TitledHelpFormatter(), usage=globals()['__doc__'], version="%prog 1.0")

      parser.add_option('-v', '--verbose',       action='store_true', default=False, help='verbose output')
      parser.add_option('-b', '--bam',           action='store',      type='string',  default="test.bam",    dest='bamfile',  help='input iCLIP bam file ') # bam/U2AF65_total_max2mis_07032014_nodup.bam
      parser.add_option('-o', '--output-dir',    action='store',      type='string',  default="output", dest='outputDir',     help='output directory')
      parser.add_option('-g', '--gtf',           action='store',      type='string',  default="/g/huber/projects/Genomes/H_sapiens/GRCh37_Ensembl75/Homo_sapiens.GRCh37.75.gtf", dest="gtfname", help="GTF annotation file")
      parser.add_option('-s', '--not-stranded',  action='store_false', default=True, dest='stranded', help='set if genome is NOT stranded')
      parser.add_option('-q', '--min-quality',   action='store',      type='int', default=10,   dest='minAlignmentQuality',  help='minimum alignment quality')
      parser.add_option('-m', '--min-read-length', action='store',    type='int', default=0,    dest='minReadLength',        help='minimum read length')
      parser.add_option('-a', '--max-read-length', action='store',    type='int', default=0,    dest='maxReadLength',         help='minimum read length')
      parser.add_option('-i', '--max-read-interval-length', action='store',  type='int', default=10000, dest='maxReadIntervalLength',  help='minimum read interval length')
      parser.add_option('-r', '--deletion-ratio', action='store',     type='float', default=0.01, dest='deletionRatio',        help='When analysing the deletions, the ratio defines the minium which is considered to be a deletion caused by a read-through')
      parser.add_option('-d', '--deletion-minimum', action='store',    type='int',   default=1, dest='minDeletions',           help='When analysing the deletions, the minium defines the minimal amounts of reads for the read-through determination')
      parser.add_option('-w', '--half-window',    action='store',    type='int',   default=100, dest='halfwindow',                 help='Half the window size for the calculations')
      parser.add_option('-t', '--sort-output',     action='store_false', default=True, dest='sortOutput', help='should the output of the data be sorted')
      parser.add_option('-p', '--primary-reads',   action='store_true', default=False,  dest='primary', help='set if you want to use only primary positions of multimapping reads')
      parser.add_option('-e', '--filter-exons',      action='store_false', default=True,  dest='filterExons', help='filter exons with multiple ends')
      parser.add_option('-f', '--force overwrite',   action='store_true', default=False,  dest='force', help='forces overwriting existing results')
      parser.add_option('-z', '--read-bed',         action='store', default='bed.bed', dest='bedname', help='optional bed file name ')

      (options, args) = parser.parse_args()

      # check if there are all arguments
      if len(args) != 0:
          parser.error ('Incorrect number of user-specifed arguments')


      # check if arguments are valid, assertions
      checkDirExistsElseCreate(options.outputDir)
      checkDirExistsElseCreate(options.outputDir)

      checkFileExists(options.bamfile)
      checkFileExists(options.gtfname)

      # execute main
      main()

   # Exception Handling: Interruption / Errors
   except KeyboardInterrupt, exception: # Control - C
      raise exception
   except SystemExit, exception:
      raise exception
   except Exception, exception:
      print '______________________________[ Error ]______________________________ '
      print str(exception)
      print '____________________________[ Traceback ]____________________________  '
      traceback.print_exc()

      os._exit(1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
